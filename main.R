library(tidyverse)
library(dplyr)
library(glue)
library(tibble)
library(purrr)
library(stringr)
library(jsonlite)

# local imports
file_sources <- list.files(c("api"), pattern = "\\.R$",
    full.names = TRUE, ignore.case = TRUE)
sapply(file_sources, source)

# Read api key from .env
if (!exists("api_key")) {
    readRenviron(".env")
    api_key <- Sys.getenv("API_KEY")
}

# Read event_key from cli if not defined
args <- commandArgs(trailingOnly = TRUE)
if (!exists("event_key")) {
    if (length(args) == 0) {
        event_key <- readline(prompt = "Enter event key: ")
    } else {
        event_key <- args[1]
    }
}

# get teams from event
# TODO: maybe change to pull from matches? (deal with teams with no matches)
event_teams <- getTeamList(event_key, api_key)

#
# Get match data for each team at event
#
raw_event_matches <- getEventMatchesRaw(event_key, api_key)
rm(list = ls(pattern = "frc"))
for (team_key in event_teams) {
    out <- getTeamMatches(raw_event_matches, team_key)
    assign(glue("{team_key}"), out)
}

#
# Generate event csv files and zip
#
out_dir <- glue("output/{event_key}")
if (!dir.exists(glue(out_dir))) {
    dir.create(glue(out_dir))
}
file.copy("output/README.md", out_dir)

# Get team OPRs and related stats

ratings <- getOpr(getEventMatches(raw_event_matches), event_teams)
write.csv(ratings, glue("output/{event_key}/{event_key}_opr.csv"))

# event-wide team stats
allteams <- data.frame()
for (team_key in ls(pattern = "frc")) {
    df <- get(team_key)
    allteams <- getEventMeans(allteams, df, ratings, team_key, event_key)
}
write.csv(allteams, glue("output/{event_key}/{event_key}_all.csv"))

# TODO: read from file? or ouput directory?
event_keys <- c("2023vabla", "2023mdbet")
merged <- merge_events(event_keys)
write.csv(merged, glue("output/events_all.csv"))

